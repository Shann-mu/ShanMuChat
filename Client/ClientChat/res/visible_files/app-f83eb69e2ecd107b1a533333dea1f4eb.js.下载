function handleClearTimeout(){aiLoadingTimer&&clearTimeout(aiLoadingTimer)}function handleAiActiveStatus(){handleClearTimeout(),aiLoadingTimer=setTimeout(()=>{codeAiInterpretation()},1e3),window.aiLoadingTimer=aiLoadingTimer}function codeAiInterpretation(){var e=aiSkylineData.request_url;aiReqLoading=!0;var t=window.gon.aiCodeParams,i={sse_mode:!0,stream:!0,type:t.type,user:t.user,messages:[{content:aiContent,type:"code",content_part:{data:t.blob,type:"action",id:aiCodeType}}]};try{window.jqxhr=$.ajax({url:e,method:"post",dataType:"json",data:JSON.stringify(i),contentType:"application/json",headers:{Authorization:`Bearer ${aiSkylineData.result.token}`},xhr:function(){var e=new window.XMLHttpRequest,t=0,i="";return e.onprogress=function(a){if("text/event-stream"===e.getResponseHeader("Content-Type")&&a.currentTarget){var n=a.currentTarget.responseText,o=n.slice(t);t=n.length;for(var r=o.split(/\n\n+/),d=0;d<r.length;d++){var s=(a=r[d]).trim();if(""!==s){s.startsWith("data:")&&(s=s.replace(/^data:\s*/,""));var c=JSON.parse(s);$(".code-parsing-content").show(),$(".skeleton").hide(),i+=c.content;var l=aiParsingMarkdownit.render(i);requestAnimationFrame(()=>{document.getElementById("code-parsing").querySelector(".markdown-body").innerHTML=l})}}}},e},success:function(e,t,i){if($(".code-parsing-content").show(),$(".skeleton").hide(),"text/event-stream"!==i.getResponseHeader("content-type")){if("finished"===e.data.state||"active"===e.data.state){var a=aiParsingMarkdownit.render(e.data.content);$("#code-parsing").find(".markdown-body").html(a)}"active"===e.data.state?handleAiActiveStatus():($(".ai_code_btns_simple").show(),handleClearTimeout(),aiReqLoading=!1)}},error:function(e){aiReqLoading=!1,$(".code-parsing-content").show(),$(".skeleton").hide(),$(".ai_code_btns_simple").show(),200!==e.status&&0!=e.status&&(Flash.error(aiSubTitle+"\u5931\u8d25"),$("#code-parsing").find(".markdown-body").html(aiSubTitle+"\u5931\u8d25......")),handleClearTimeout()}})}catch(a){console.log(a),aiReqLoading=!1,Flash.error(aiSubTitle+"\u5931\u8d25"),$(".code-parsing-content").show(),$(".skeleton").hide(),$(".ai_code_btns_simple").show(),$("#code-parsing").find(".markdown-body").html(aiSubTitle+"\u5931\u8d25......"),handleClearTimeout()}}function closeAiCodeParsing(){window.jqxhr&&window.jqxhr.abort(),window.Gitee.setFullscreen(!1),$(".side-toolbar").show(),$("#project-wrapper").css("marginTop","-16px"),$("#git-footer-main").css("margin-top","48px"),$("#git-project-container").attr("style","width: 100% !important;"),$(".git-project-content-wrapper").find("#sixteen").attr("style","width: 100% !important;"),$(".right-wrapper").attr("style","width: 100% !important;"),$(".project-conter-container").attr("style","width: 100% !important;"),$("#code-parsing").css("width",0),$("#code-parsing").removeClass("code-parsing-box"),$(".js-code-parsing-img").removeClass("code-parsing-img"),$("#code-parsing").find(".markdown-body").html(""),$(".js-code-parsing-img").empty(),$(".ai_code_btns_simple").hide(),handleClearTimeout()}function handleAiReqInit(){handleClearTimeout(),aiReqLoading||($(".code-parsing-content").hide(),$(".skeleton").show(),$(".ai_code_btns_simple").hide(),$(".sub_title").text("\u4ee5\u4e0b\u662f\u5bf9\u5f53\u524d\u6587\u4ef6\u7684"+aiSubTitle+"\uff1a"),$("#code-parsing").find(".markdown-body").html(""),$(".js-code-parsing-img").removeClass("code-parsing-img"),$(".js-code-parsing-img").empty(),codeAiInterpretation(),$(".ai_code_btns_simple").find(`.btn_box[data-value="${aiCodeType}"]`).hide(),$(".ai_code_btns_simple").find(".btn_box:not([data-value='"+aiCodeType+"'])").show())}var aiLoadingTimer=0,aiReqLoading=!1,aiCodeType="",aiSubTitle="",aiContent="",aiParsingMarkdownit=window.markdownit(),aiSkylineData=window.Gitee.aiAssistant.aiSkylineData;$("#code-parsing").find(".gitee-icon-close").on("click",function(){closeAiCodeParsing()}),$(".ai_code_btns_simple").find(".btn_box").on("click",function(){aiCodeType=$(this).data("value"),aiSubTitle=$(this).data("text"),aiContent=$(this).data("content"),handleAiReqInit()}),window.addEventListener("beforeunload",function(){window.jqxhr&&window.jqxhr.abort(),handleClearTimeout()});